<formr>
    <form name={props.id} onchange={validate} oninput={validate} novalidate>
        <div each={ (field, i) in state.desc }>
            <div class="form-group" name="fgroup_{field.id || i}">
                <div is={'i'+callType(field.type)} field={field} attr={state.attr} index={i}></div>
            </div>
        </div>
    </form>
    <script>
        export default {
            onBeforeMount() {
                this.state.desc = window.fields[this.props.id].desc
                this.state.attr = window.fields[this.props.id].attr
            },
            onMounted(){
              this.ctrlRun()  
            },
            callType(type) {
                let types = ['textarea', 'date', 'color', 'datetime', 'datetime-local', 'email', 'month', 'number', 'tel', 'time', 'url', 'week']
                if (types.indexOf(type) > -1) return 'text'
                else return type
            },
            click() {
                this.fields.push({
                    type: 'text',
                    size: 10,
                    value: 'First item'
                })
                this.update()
            },
            ctrlRun() {
                document.querySelectorAll("input[ctrlChecked][ctrlUnchecked]").forEach(function(elt) {
                    elt.getAttribute("ctrlChecked").split(',').forEach(function(name) {
                        //node = '[name=fgroup_' + name+']'
                        name='fgroup_' + name
                        node=document.getElementsByName(name)[0]
                        if (elt.checked) {
                            //animateCSS(node,'fadeInDown')
                            //document.getElementsByName(name)[0].classList.add('animated','fadeInDown') //remove('hide')
                            node.classList.add('fadeInDown')
                        } else
                            node.classList.add('fadeOutDown')
                             //animateCSS(node,'fadeOutDown')
                            //document.getElementsByName(name)[0].classList.add('animated','fadeOutDown') //add('hide')

                    })
                    elt.getAttribute("ctrlUnchecked").split(',').forEach(function(name) {
                        //node = '[name=fgroup_' + name+']'
                        name='fgroup_' + name
                         node=document.getElementsByName(name)[0]
                        if (elt.checked) {
                            node.classList.add('fadeOutDown')
                            //document.getElementsByName(name)[0].classList.add('animated','fadeOutDown') //add('hide')
                            // animateCSS(node,'fadeOutDown')
                        } else
                            node.classList.add('fadeInDown')
                             //animateCSS(node,'fadeInDown')
                            //document.getElementsByName(name)[0].classList.add('animated','fadeInDown') //remove('hide') 

                    })
                })



                /*ctrls.split(',').forEach(function(name) {
                    document.getElementsByName(name)[0].classList.add('hide')
                })*/
            },

            validate(ev) {
                this.ctrlRun()
                var invalidFeedback = '<i class="text-danger fas fa-times fa-fw mx-2" aria-hidden="true"></i>'
                var invalidFeedbackMsg = '<i class="text-danger fas fa-exclamation-triangle fa-fw mx-2" aria-hidden="true"></i>'
                var validFeedback = '<i class="text-success fas fa-check fa-fw mx-2" aria-hidden="true"></i>'
                var feedBackElt = ev.target.closest(".form-group").querySelector(".inputFeedback")
                var feedBackMsgElt = ev.target.closest(".form-group").querySelector(".inputFeedbackMsg")
                var field = ev.target
                var validity = ev.target.validity
                var isValid = validity.valid
                var msg = ''
                //console.log(ev.target.validity) 
                //console.log(Object.keys(ev.target.validity))


                switch (true) {
                    // Don't validate some
                    case field.disabled || field.type == 'file':
                        return
                        break
                        // If field is required and empty
                    case validity.valueMissing:
                        msg += 'Fill out this field. '
                        break
                        // If not the right type
                    case validity.typeMismatch:
                        // Email
                        if (field.type == 'email') msg += 'Enter an email address. '
                        // URL
                        if (field.type == 'url') msg += 'Enter a URL. '
                        break
                        // If too short
                    case validity.tooShort:
                        msg += 'Lengthen this text to ' + field.getAttribute('minLength') + ' characters or more. You are currently using ' + field.value.length + ' characters. '
                        break
                        // If too long
                    case validity.tooLong:
                        msg += 'Shorten this text to no more than ' + field.getAttribute('maxLength') + ' characters. You are currently using ' + field.value.length + ' characters. '
                        break
                        // If number input isn't a number
                    case validity.badInput:
                        msg += 'Enter a number. '
                        break
                        // If a number value doesn't match the step interval
                    case validity.stepMismatch:
                        msg += 'Select a valid value. '
                        break
                    case validity.rangeOverflow:
                        msg += 'Select a value that is no more than ' + field.getAttribute('max') + '. '
                        break
                        // If a number field is below the min
                    case validity.rangeUnderflow:
                        msg += 'Select a value that is no less than ' + field.getAttribute('min') + '. '
                        break
                        // If pattern doesn't match
                    case validity.patternMismatch:
                        // If pattern info is included, return custom error
                        if (field.hasAttribute('title')) msg += field.getAttribute('title')
                        // Otherwise, generic error
                        else msg += 'Match the requested format. '
                        break
                }

                // If all else fails, return a generic catchall error
                if (!isValid && !msg) msg = 'The value you entered for this field is invalid. '


                feedBackElt.innerHTML = (isValid ? validFeedback : invalidFeedback)
                feedBackMsgElt.innerHTML = isValid ? '' : invalidFeedbackMsg + ' ' + this.i18n(msg)

                //enable buttons with attributes 'waitValid' if all fields in the form is valid
                nbInvalidFields = ev.target.closest("form").querySelectorAll('.form-control:invalid')
                //console.log('# input invalid',nbInvalidFields.length)
                waitValid = ev.target.closest("form").querySelectorAll('[waitvalid]')
                waitValid.forEach(function(e) {
                    e.disabled = nbInvalidFields.length
                })
            }
        }

    </script>
    <style>
        /*-- redefine some bootstrap style --*/
        .hide,
        .form-inline .hide {
            display: none;
        }

        .form-group {
            margin-bottom: 1.5rem;
            /*bottom margin after each field*/
        }


        label {
            font-size: 1.1rem;
            font-weight: 500;
        }

        button:disabled {
            cursor: not-allowed;
        }

        button:focus,
        input:focus,
        textarea:focus {
            outline: none !important;
            border-color: #719ECE !important;
            box-shadow: 0 0 10px #719ECE !important;
        }

        .fucfirst:first-letter {
            text-transform: capitalize;
        }
        
        

    </style>
</formr>
